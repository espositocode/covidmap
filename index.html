<!doctype html>
<html lang="en">
<head>
    <title>CovidMap</title>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="author" content="Jonathan Esposito">
    <meta name="description" content="Plot covid cases geographically over time">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
    <link rel="preconnect" href="https://fonts.googleapis.com"> 
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <style>
        html, body {
            background: #19181a;
            cursor:default;
            overflow: hidden;
            width: 100%;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
        }
    
        #map {
            bottom: 0px;
            left: 0px;
            position: absolute;
            right: 0px;
            top: 0px;
        }
    
        #timeline {
            background: #19181aaa;
            bottom: 0px;
            height: 100px;
            left: 0px;
            position: absolute;
            right: 0px;
            z-index: 999;
        }
    
        #timeline .cdline {
            fill: none;
            opacity: 1;
            stroke: #78dce8;
            stroke-width: 2px;
            z-index: 999;
        }

        #timeline .vrline {
            fill: none;
            opacity: 1;
            stroke: #ab9df2;
            stroke-width: 2px;
            z-index: 999;
        }

        #timeline .ndline {
            fill: none;
            opacity: 1;
            stroke: #a9dc76;
            stroke-width: 2px;
            z-index: 999;
        }

        #timeline .overline {
            fill: none;
            opacity: 1;
            stroke: #403e41;
            stroke-width: 2px;
            z-index: 9999;
        }
    
        #timeline .underaxis .tick text {
            fill: #ffd866;
            font-family: 'Fira Code', Helvetica, sans-serif;
            opacity: 1;
        }

        #timeline .overaxis .tick text {
            fill: #000;
            font-family: 'Fira Code', Helvetica, sans-serif;
            opacity: 1;
            z-index: 99999999;
        }
    
        #timeline .tick line {
            display: none;
        }
        
        #timeline .selection {
            fill: #ffd866;
            fill-opacity: 1;
            opacity: 1;
            stroke: none;
            z-index: 1;
        }
    
        #topbar {
            background: #19181aaa;
            font: 13px 'Fira Code', Helvetica, sans-serif;
            color: #ffd866; 
            left: 0px;
            padding: 5px 10px 5px 10px;
            position: absolute;
            right: 0px;
            top: 0px;
            z-index: 999;
        }
       
        #topbar .about {
            color: #ffd866;
            text-decoration: underline;
            
        }
        
        #topbar .right {
            float: right;
        }
    
        #topbar .sep {
            padding-left: 5px; 
            padding-right: 5px;
            color: #403e41;
            font-weight: bold;
        }

        #topbar .data {
            display: inline-block;
        }
    
        #notice {
            background: #ffd866;
            bottom: 100px;
            border-radius: 5px;
            border-color: #657b83aa;
            border-width: 0px;
            border-style: solid;
            color: #19181a;
            display: none;
            font-family: 'Fira Code', Helvetica, sans-serif;
            font-size: 13px;
            position: absolute;
            margin: 10px;
            padding: 5px 10px 5px 10px;
            right: 0px;
            text-align: center;
            vertical-align: center;
            z-index: 999;
        }
    
        #notice .arrow {
            float: right;
            padding-left: 10px;
            font-weight: bold;
        }
    
        .leaflet-container {
            background: #221f22;
        }
    
        .leaflet-control-attribution {
            display: none;
        }

        .cd {
            color: #78dce8;
        }
        
        .nd {
            color: #a9dc76;
        }
        
        .vr {
            color: #ab9df2;
        }

        #cd-title::before {
            content: "Case Density";
        }

        #vr-title::before {
            content: "Vaccination Ratio";
        }
   
        #nd-title::before {
            content: "New Deaths";
        }

        @media only screen and (max-width: 768px) {
            #cd-title::before {
                content: "CD";
            }

            #nd-title::before {
                content: "ND";
            }

            #vr-title::before {
                content: "VR";
            }

            #topbar {
                font-size: 12px;
            }
    
            #notice {
                left: 0px;
                padding-left:19px;
                right: 0px;
                width: auto;
            }
    
            .location-wrapper {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="topbar">
        <span id="date-begin"></span>
        <span id="date-end"></span>
        <span class="location-wrapper">
            <span class="sep">|</span>
            <span id="location"></span>
        </span>
        <span class="right"><a href="about.html"><span class="about">About</a></span></span>
        <br/>
        <span class="cd"><span id="cd-title"></span>: <span id="cd-data">---</span></span>
        <span class="sep">|</span>
        <span class="nd"><span id="nd-title"></span>: <span id="nd-data">---</span></span>
        <span class="sep">|</span>
        <span class="vr"><span id="vr-title"></span>: <span id="vr-data">-.--</span></span>
        <span class="right"></span>
        
    </div>
    <div id="timeline"> </div>
    <div id="notice">Drag the slider to show changes over time <span class="arrow">&darr;</span></div>
</body>
<script>
    function preventBehavior(e) {
        e.preventDefault(); 
    };
    document.addEventListener("touchmove", preventBehavior, {passive: false});

    const fips = {
        "10": "Delaware",
        "11": "District of Columbia",
        "12": "Florida",
        "13": "Georgia",
        "15": "Hawaii",
        "16": "Idaho",
        "17": "Illinois",
        "18": "Indiana",
        "19": "Iowa",
        "20": "Kansas",
        "21": "Kentucky",
        "22": "Louisiana",
        "23": "Maine",
        "24": "Maryland",
        "25": "Massachusetts",
        "26": "Michigan",
        "27": "Minnesota",
        "28": "Mississippi",
        "29": "Missouri",
        "30": "Montana",
        "31": "Nebraska",
        "32": "Nevada",
        "33": "New Hampshire",
        "34": "New Jersey",
        "35": "New Mexico",
        "36": "New York",
        "37": "North Carolina",
        "38": "North Dakota",
        "39": "Ohio",
        "40": "Oklahoma",
        "41": "Oregon",
        "42": "Pennsylvania",
        "44": "Rhode Island",
        "45": "South Carolina",
        "46": "South Dakota",
        "47": "Tennessee",
        "48": "Texas",
        "49": "Utah",
        "50": "Vermont",
        "51": "Virginia",
        "53": "Washington",
        "54": "West Virginia",
        "55": "Wisconsin",
        "56": "Wyoming",
        "01": "Alabama",
        "02": "Alaska",
        "04": "Arizona",
        "05": "Arkansas",
        "06": "California",
        "08": "Colorado",
        "09": "Connecticut",
        "72": "Puerto Rico",
        "66": "Guam",
        "78": "Virgin Islands",
        "60": "American Samoa"
    }

    const today = new Date()

    const nullbg = '#262427'
    const colors = ['#EFE09B', '#F1c676', '#F2AC54', '#F19140', '#EB7331', '#DF5B2A', '#C74638', '#B73839', '#A12C45', '#80233A', '#671D46', '#45133C']
    
    var notice = false;
    var country = null;
    var geoLayer = null;

    var selectedMean = {}
    var selectedDates = null;
    var selectedRange = [-31, 0];
    
    var map = L.map('map', {zoomControl: false}).setView([37, -95], 4)
    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
        attribution: '', 
        maxZoom: 18,
        id: 'espositocode/ckz3j0244000514qk2q3zwu6y',
        tileSize: 512,
        zoomOffset: -1,
        accessToken: 'pk.eyJ1IjoiZXNwb3NpdG9jb2RlIiwiYSI6ImNreXlqaWFiZzA5cWUybnJtdXhheXh2bXQifQ.WgKbAeSzL4uYV1PlIzjMIw'
    }).addTo(map);

    function datediff(first, second) {
        return Math.round((second - first) / (1000 * 60 * 60 * 24));
    }

    function datedays(days) {
        var date = new Date();
        date.setDate(date.getDate() - days);
        return date;
    }

    function getcolor(cd) {
        if (cd == null || isNaN(cd)) {
            return nullbg;
        }

        return cd > 250 ? colors[11] :
               cd > 175 ? colors[10] :
               cd > 100 ? colors[8] :
               cd > 85  ? colors[8] :
               cd > 75  ? colors[7] :
               cd > 60  ? colors[6] :
               cd > 50  ? colors[5] :
               cd > 40  ? colors[4] :
               cd > 30  ? colors[3] :
               cd > 20  ? colors[2] :
               cd > 10  ? colors[1] :
                          colors[0];
    }

    function getmean(data) {
        if (!selectedRange || !data) {
            return null;
        }

        if (selectedRange[1] == 0) {
            return d3.mean(data.slice(selectedRange[0]));
        } else {
            return d3.mean(data.slice(selectedRange[0], selectedRange[1]));
        }
    }

    function mouseover(e) {
        e.target.setStyle({
            color: "#fff",
            weight: 2,
            opacity: 1
        });

        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            e.target.bringToFront();
        }

        topbar(e.target.feature.properties);
    }

    function mouseout(e) {
        geoLayer.resetStyle(e.target);
        topbar();
    }

    function style(feature) {
        return {
            weight: .5, 
            color: "#EFE09B",
            fillColor: getcolor(getmean(feature.properties["cd"])),
            opacity: .05,
            fillOpacity: 1
        };
    }

    function onEachFeature(feature, layer) {
        layer.on({
            mouseover: mouseover,
            mouseout: mouseout,
        });
    }

    function topbar(county) {
        if (!geoLayer || !selectedDates) {
            // we are still loading data
            return;
        }

        document.getElementById('date-begin').innerHTML = selectedDates[0].toISOString().split('T')[0] 
        document.getElementById('date-end').innerHTML = selectedDates[1].toISOString().split('T')[0]

        if (county) {
            document.getElementById('location').innerHTML = county.name + ", " + fips[county.state]
        } else {
            document.getElementById('location').innerHTML = "United States"
        }

        if (selectedMean["cd"]) {
            document.getElementById('cd-data').innerHTML = Math.round(selectedMean["cd"]).toString().padStart(3, '0')
        } else {
            document.getElementById('cd-data').innerHTML = "---"
        }
        
        if (selectedMean["nd"]) {
            document.getElementById('nd-data').innerHTML = Math.round(selectedMean["nd"]).toString().padStart(4, '0')
        } else {
            document.getElementById('nd-data').innerHTML = "---&nbsp;"
        }

        if (selectedMean["vr"]) {
            document.getElementById('vr-data').innerHTML = selectedMean["vr"].toFixed(2)
        } else {
            document.getElementById('vr-data').innerHTML = "-.--"
        }
    };

    function timeline() {
        var margin = { top: 0, right: 0, bottom: 0, left: 0 },
            width = window.innerWidth,
            height = 100

        var x = d3.scaleTime().range([0, width]);
        var y = d3.scaleLinear().range([height, 0]);

        var line = d3.line()
            .x(function (d) { return x(d.date); })
            .y(function (d) { return y(d.data); });
        
        var svg = d3.select("#timeline").append("svg")
            .attr("class", "country")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var clip = svg.append("defs")
            .append("clipPath")
            .attr("id", "rect-clip")
        
        var rect = clip.append("rect")
            .attr("id", "my-rect")
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", 0)
            .attr("height", 100);

        var cddata = []
        var nddata = []
        var vrdata = []

        var cdmax = Math.max(...country["cd"])
        var end = true;
        for (idx = country["cd"].length-1; idx >= 0; idx--) {
            if (end == true && country["cd"][idx] == null) {
                continue
            } else {
                end = false;
            }
            cddata.push(
                {
                    "data": country["cd"][idx]/cdmax,
                    "date": datedays(country["cd"].length - idx)
                }
            )
        };

        var ndmax = Math.max(...country["nd"])
        var end = true;
        for (idx = country["nd"].length-1; idx >= 0; idx--) {
            if (end == true && country["nd"][idx] == null) {
                continue
            } else {
                end = false;
            }
            nddata.push(
                {
                    "data": country["nd"][idx]/ndmax,
                    "date": datedays(country["nd"].length - idx)
                }
            )
        };

        var end = true;
        for (idx = country["vr"].length-1; idx >= 0; idx--) {
            if (end == true && country["vr"][idx] == null) {
                continue
            } else {
                end = false;
            }
            vrdata.push(
                {
                    "data": country["vr"][idx],
                    "date": datedays(country["vr"].length - idx)
                }
            )
        };

        x.domain(d3.extent(cddata, function (d) {
            return d.date;
        }));

        y.domain([0, d3.max(cddata, function (d) {
            return 1;
        })]);

        var defaultSelection = null;
        if (window.innerWidth > 768) {
            defaultSelection = [x(d3.utcMonth.offset(x.domain()[1], -1)), x.range()[1]];
        } else if (window.innerWidth > 428) {
            defaultSelection = [x(d3.utcMonth.offset(x.domain()[1], -2)), x.range()[1]];
        } else {
            defaultSelection = [x(d3.utcMonth.offset(x.domain()[1], -3)), x.range()[1]];
        }

        function brushed(d) {
            if (notice) {
                document.getElementById('notice').style.display = 'none';
                notice = true;
            }

            console.log()
            rect.attr("x", d3.event.selection[0])
                .attr("y", 0)
                .attr("width", d3.event.selection[1]-d3.event.selection[0]);

            if (d3.event.selection) {
                selectedDates = d3.event.selection.map(x.invert, x)
            } else {
                d3.select(this).call(brush.move, defaultSelection);
                selectedDates = d3.event.selection.map(x.invert, x)
            }

            selectedRange = [datediff(today, selectedDates[0]), datediff(today, selectedDates[1])]

            selectedMean = {
                "cd": getmean(country["cd"]),
                "vr": getmean(country["vr"]),
                "nd": getmean(country["nd"])
            }

            d3.select(".overline").style("clip", getcolor(selectedMean["cd"]))

            //d3.select(".selection").style("fill", getcolor(selectedMean["cd"]))
            topbar()
            if (geoLayer) {
                geoLayer.resetStyle()
            }
        }

        var brush = d3.brushX()
            .extent([[0, 0], [width, height]])
            .on("brush end", brushed)

        svg.append("g")
            .attr("class", "brush")
            .call(brush)
            .call(brush.move, defaultSelection);

        svg.append("path")
            .data([cddata])
            .attr("class", "cdline")
            .attr("d", line);
        
        svg.append("path")
            .data([vrdata])
            .attr("class", "vrline")
            .attr("d", line);
        
        svg.append("path")
            .data([nddata])
            .attr("class", "ndline")
            .attr("d", line);

        svg.append("path")
            .data([cddata])
            .attr("class", "overline")
            .attr("clip-path", "url(#rect-clip)")
            .attr("d", line);
        
        svg.append("path")
            .data([vrdata])
            .attr("class", "overline")
            .attr("clip-path", "url(#rect-clip)")
            .attr("d", line);
        
        svg.append("path")
            .data([nddata])
            .attr("class", "overline")
            .attr("clip-path", "url(#rect-clip)")
            .attr("d", line);

        svg.append("g")
            .attr("class", "axis underaxis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisTop(x));

        /*
        svg.append("g")
            .attr("class", "axis overaxis")
            .attr("clip-path", "url(#rect-clip)")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisTop(x));
        */

        document.getElementById('notice').style.display = 'block';
        notice = true;
        topbar()
    }

    function resize() {
        d3.select(".country").remove();
        timeline()
    }

    d3.json('/data/county.geo.json', function (data) {
        geoLayer = L.geoJson(data, { style: style, onEachFeature: onEachFeature, smoothFactor: .5 }).addTo(map);
        topbar()
    });

    d3.json('/data/country.json', function (data) {
        country = data
        timeline()
    });

    d3.select(window).on('resize', resize);
</script>
</html>